Bootstrap: localimage
From: spack_all.sif
Stage: build

%post
  . /opt/spack/share/spack/setup-env.sh
  spack env activate virtual_fugaku
  spack gc -y
  spack clean --all

Bootstrap: docker
From: redhat/ubi8
Stage: final

%setup
  mkdir ${SINGULARITY_ROOTFS}/opt/amazon

%files from build
  /opt/spack
  /usr/lib64/libhwloc.so.15.6.4

%post
  dnf -y install libevent*
  dnf clean all

  cd /usr/lib64
  ln -s libhwloc.so.15.6.4 libhwloc.so

  . /opt/spack/share/spack/setup-env.sh
  spack env activate --sh virtual_fugaku >> $SINGULARITY_ENVIRONMENT
