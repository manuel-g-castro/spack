Bootstrap: docker
From: redhat/ubi8

%setup
  mkdir ${SINGULARITY_ROOTFS}/opt/amazon

%files
# /opt/amazon

%post

  dnf -y install https://dl.fedoraproject.org/pub/epel/epel-release-latest-8.noarch.rpm
  dnf -y install git gcc* make xz patch bzip2* autoconf* automake libtool* libevent*
  dnf -y install binutils ctags curl findutils gdb glibc-devel gnupg2 hostname iproute perl-Fedora-VSP perl-generators perl-Sys-Syslog pkgconf* python39 python3-boto3 python3-pip python3-setuptools redhat-lsb-core redhat-rpm-config source-highlight strace unzip
  dnf repolist
  dnf list installed

  cd /opt
  git clone https://github.com/RIKEN-RCCS/spack.git
  cd spack
  git checkout virtual_fugaku

  . ./share/spack/setup-env.sh

  spack install hwloc
  HWLOC=$(find /opt/spack/opt/spack/linux-rhel8-neoverse_v1 -name 'libhwloc.so.15.*' | tail -n 1)
  ln -s ${HWLOC} /usr/lib64
  ln -s ${HWLOC} /usr/lib64/libhwloc.so
  ln -s ${HWLOC} /usr/lib64/libhwloc.so.15

  spack install gcc+binutils
  spack load gcc
  spack compiler find
  spack env create virtual_fugaku etc/spack/spack.yaml
  spack env activate -p virtual_fugaku
  spack add gcc
  spack concretize
  spack install

  spack env deactivate

  spack env activate --sh virtual_fugaku >> $SINGULARITY_ENVIRONMENT
